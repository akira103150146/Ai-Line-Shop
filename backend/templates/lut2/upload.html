<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KAGI LUTS - 上傳介面</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111111;
            color: #f3f4f6;
            overflow-x: hidden; /* 防止手機橫向滾動 */
        }

        /* 隱藏原生 Input */
        input[type="file"] {
            display: none;
        }

        /* 掃描線動畫 */
        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .animate-scan {
            animation: scan 2s linear infinite;
        }

        /* 點擊效果 */
        .active-press:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #CFFF04 !important;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">

    <!-- 背景裝飾 -->
    <div class="absolute inset-0 z-0 opacity-20 pointer-events-none" 
         style="background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;">
    </div>

    <!-- 頂部標題 (簡化版，適應手機) -->
    <header class="relative z-20 bg-black/90 border-b border-[#333] p-4 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-[#CFFF04] text-black p-1.5 border border-white">
                <i data-lucide="upload-cloud" width="20" height="20"></i>
            </div>
            <h1 class="text-xl font-black italic tracking-tighter">
                KAGI  <span class="text-[#CFFF04]"> LUTS </span>
            </h1>
        </div>
    </header>

    <!-- 主要內容區 -->
    <main class="flex-1 relative z-10 flex flex-col items-center justify-center p-6 gap-6 w-full max-w-md mx-auto">

        <!-- 1. 尺寸選擇控制台 -->
        <div class="w-full grid grid-cols-2 gap-4">
            <!-- 直式按鈕 -->
            <button onclick="setOrientation('portrait')" id="btn-portrait" 
                class="active-press relative group p-3 border-2 border-[#CFFF04] bg-[#CFFF04] text-black transition-all shadow-[4px_4px_0px_#333]">
                <div class="flex flex-col items-center gap-1">
                    <i data-lucide="smartphone" class="w-6 h-6"></i>
                    <span class="font-black text-xs tracking-wider">PORTRAIT</span>
                    <span class="text-[10px] font-mono opacity-80">直式</span>
                </div>
                <!-- 選擇標記 -->
                <div class="check-mark absolute top-1 right-1 opacity-100">
                    <i data-lucide="check-circle-2" width="14"></i>
                </div>
            </button>

            <!-- 橫式按鈕 -->
            <button onclick="setOrientation('landscape')" id="btn-landscape" 
                class="active-press relative group p-3 border-2 border-[#333] bg-[#1a1a1a] text-gray-400 transition-all shadow-[4px_4px_0px_#000]">
                <div class="flex flex-col items-center gap-1">
                    <i data-lucide="monitor" class="w-6 h-6"></i>
                    <span class="font-black text-xs tracking-wider">LANDSCAPE</span>
                    <span class="text-[10px] font-mono opacity-80">橫式</span>
                </div>
                <div class="check-mark absolute top-1 right-1 opacity-0">
                    <i data-lucide="check-circle-2" width="14"></i>
                </div>
            </button>
        </div>

        <!-- 2. 上傳預覽區 (主要互動區) -->
        <div class="relative w-full flex justify-center items-center py-4">
            
            <!-- 外框裝飾 -->
            <div id="frame-container" class="relative transition-all duration-500 ease-out bg-[#1a1a1a] border-2 border-[#CFFF04] shadow-[8px_8px_0px_rgba(0,0,0,0.8)] p-1 w-[280px] h-[380px]">
                
                <!-- 圖片顯示區域 / 觸發按鈕 -->
                <div class="relative w-full h-full bg-gray-900 overflow-hidden cursor-pointer group" onclick="triggerUpload()">
                    
                    <!-- 預設狀態 (無圖片) -->
                    <div id="placeholder-ui" class="absolute inset-0 flex flex-col items-center justify-center text-[#CFFF04] gap-4 z-10 transition-opacity duration-300">
                        <!-- 巨大的 + 號 -->
                        <div class="w-20 h-20 border-2 border-dashed border-[#CFFF04] rounded-full flex items-center justify-center group-hover:scale-110 transition-transform bg-black/50 backdrop-blur-sm">
                            <i data-lucide="plus" width="48" height="48"></i>
                        </div>
                        <p class="text-xs font-mono tracking-widest text-center">
                            TAP TO UPLOAD <br>
                            點擊上傳圖片 <br>
                            <span class="opacity-50 text-[10px]">JPG / PNG</span>
                        </p>
                    </div>

                    <!-- 圖片預覽 (預設隱藏) -->
                    <img id="image-preview" src="" class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-500 filter contrast-125 grayscale-[0.2]" alt="Preview">
                    
                    <!-- 裝飾：掃描網格 -->
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/3px-tile.png')] opacity-20 pointer-events-none z-20"></div>
                    
                    <!-- 裝飾：掃描線 (上傳後顯示) -->
                    <div id="scan-line" class="hidden absolute inset-0 border-b-2 border-[#CFFF04]/50 z-30 animate-scan pointer-events-none bg-gradient-to-b from-transparent to-[#CFFF04]/10 h-full"></div>
                </div>

                <!-- 邊角裝飾 -->
                <div class="absolute -top-1 -left-1 w-3 h-3 border-t-2 border-l-2 border-[#CFFF04]"></div>
                <div class="absolute -bottom-1 -right-1 w-3 h-3 border-b-2 border-r-2 border-[#CFFF04]"></div>
            </div>
        </div>

        <!-- 隱藏的 Input -->
        <input type="file" id="file-upload" accept="image/*" onchange="handleFileSelect(event)">

        <!-- 底部裝飾/提示 -->
        <div class="w-full text-center">
            <p id="status-text" class="text-[#CFFF04] font-mono text-xs animate-pulse">
                WAITING FOR INPUT...
            </p>
        </div>

        <!-- 確認上傳按鈕 (選圖片後出現) -->
        <button id="confirm-btn" class="hidden w-full bg-[#CFFF04] text-black font-black text-lg py-4 border-2 border-white shadow-[4px_4px_0px_#fff] active:translate-y-1 active:shadow-none transition-all uppercase tracking-widest flex items-center justify-center gap-2">
            <i data-lucide="zap"></i> PROCESS IMAGE
        </button>

    </main>

    <script>
        // 初始化 Icons
        lucide.createIcons();

        // DOM 元素
        const btnPortrait = document.getElementById('btn-portrait');
        const btnLandscape = document.getElementById('btn-landscape');
        const frameContainer = document.getElementById('frame-container');
        const fileInput = document.getElementById('file-upload');
        const imagePreview = document.getElementById('image-preview');
        const placeholderUi = document.getElementById('placeholder-ui');
        const scanLine = document.getElementById('scan-line');
        const statusText = document.getElementById('status-text');
        const confirmBtn = document.getElementById('confirm-btn');

        let currentOrientation = 'portrait';
        let selectedFile = null; // 儲存選中的文件

        // 1. 切換尺寸 (直式/橫式)
        function setOrientation(type) {
            currentOrientation = type;

            // 重置樣式
            const activeClass = "bg-[#CFFF04] text-black border-[#CFFF04] shadow-[4px_4px_0px_#333]";
            const inactiveClass = "bg-[#1a1a1a] text-gray-400 border-[#333] shadow-[4px_4px_0px_#000]";

            if (type === 'portrait') {
                // 按鈕樣式
                updateBtnStyle(btnPortrait, true);
                updateBtnStyle(btnLandscape, false);
                
                // 框框變形 (直式)
                frameContainer.style.width = '280px';
                frameContainer.style.height = '380px';
            } else {
                // 按鈕樣式
                updateBtnStyle(btnPortrait, false);
                updateBtnStyle(btnLandscape, true);

                // 框框變形 (橫式) - 寬度稍微縮小適應手機，但比例是橫的
                frameContainer.style.width = '340px'; // 稍微窄一點適應手機寬度
                frameContainer.style.height = '240px';
            }
        }

        function updateBtnStyle(btn, isActive) {
            const checkMark = btn.querySelector('.check-mark');
            if (isActive) {
                btn.className = `active-press relative group p-3 border-2 transition-all bg-[#CFFF04] text-black border-[#CFFF04] shadow-[4px_4px_0px_#333]`;
                checkMark.style.opacity = '1';
            } else {
                btn.className = `active-press relative group p-3 border-2 transition-all bg-[#1a1a1a] text-gray-400 border-[#333] shadow-[4px_4px_0px_#000]`;
                checkMark.style.opacity = '0';
            }
        }

        // 2. 觸發上傳
        function triggerUpload() {
            fileInput.click();
        }

        // 3. 處理圖片選擇
        function handleFileSelect(event) {
            const file = event.target.files[0];
            
            if (file) {
                selectedFile = file; // 保存文件
                const reader = new FileReader();
                
                // 讀取前狀態
                statusText.innerText = "READING DATA STREAM...";
                
                reader.onload = function(e) {
                    // 設定圖片
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('opacity-0');
                    placeholderUi.classList.add('opacity-0');
                    
                    // 開啟掃描特效
                    scanLine.classList.remove('hidden');
                    
                    // 顯示確認按鈕
                    confirmBtn.classList.remove('hidden');
                    
                    // 更新狀態文字
                    statusText.innerText = "IMAGE LOADED // READY TO PROCESS";
                    statusText.classList.remove('animate-pulse');
                    
                    // 根據圖片原始比例自動建議方向 (選用功能，目前以使用者手選為主，但可以加入提示)
                    const img = new Image();
                    img.onload = function() {
                        if (this.width > this.height && currentOrientation === 'portrait') {
                            // 只是 console 提示，不強制切換，尊重使用者選擇
                            console.log("Suggestion: Switch to Landscape");
                        }
                    }
                    img.src = e.target.result;
                }
                
                reader.readAsDataURL(file);
            }
        }

        // 4. 處理圖片上傳
        async function uploadImage() {
            if (!selectedFile) {
                statusText.innerText = "ERROR: NO FILE SELECTED";
                return;
            }

            // 更新狀態
            statusText.innerText = "UPLOADING...";
            statusText.classList.add('animate-pulse');
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = '0.5';

            try {
                // 方式1：使用 FormData 上傳文件（推薦）
                const formData = new FormData();
                formData.append('image', selectedFile);
                formData.append('orientation', currentOrientation);

                const response = await fetch('/lut2/upload-image', {
                    method: 'POST',
                    body: formData,
                    // 注意：使用 FormData 時不要設定 Content-Type，瀏覽器會自動設定
                });

                const result = await response.json();

                if (result.success) {
                    statusText.innerText = "UPLOAD SUCCESS!";
                    statusText.classList.remove('animate-pulse');
                    statusText.style.color = '#CFFF04';
                    
                    // 可以顯示成功訊息或重定向
                    setTimeout(() => {
                        alert('圖片上傳成功！\n圖片 ID: ' + result.id);
                        // 可選：重置表單
                        // resetForm();
                    }, 500);
                } else {
                    throw new Error(result.message || '上傳失敗');
                }
            } catch (error) {
                statusText.innerText = `ERROR: ${error.message}`;
                statusText.style.color = '#ff4444';
                console.error('Upload error:', error);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.style.opacity = '1';
            }
        }

        // 4b. 使用 Base64 上傳（備選方案）
        async function uploadImageBase64() {
            if (!selectedFile) {
                statusText.innerText = "ERROR: NO FILE SELECTED";
                return;
            }

            statusText.innerText = "UPLOADING (BASE64)...";
            statusText.classList.add('animate-pulse');
            confirmBtn.disabled = true;

            try {
                // 讀取文件為 base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Data = e.target.result; // 包含 data:image/...;base64, 前綴
                    
                    const response = await fetch('/lut2/upload-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            image_base64: base64Data,
                            orientation: currentOrientation,
                            filename: selectedFile.name
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        statusText.innerText = "UPLOAD SUCCESS! (BASE64)";
                        statusText.classList.remove('animate-pulse');
                        statusText.style.color = '#CFFF04';
                        alert('圖片上傳成功！（Base64 格式）\n圖片 ID: ' + result.id);
                    } else {
                        throw new Error(result.message || '上傳失敗');
                    }
                };
                
                reader.onerror = function() {
                    throw new Error('讀取文件失敗');
                };
                
                reader.readAsDataURL(selectedFile);
            } catch (error) {
                statusText.innerText = `ERROR: ${error.message}`;
                statusText.style.color = '#ff4444';
                console.error('Upload error:', error);
            } finally {
                confirmBtn.disabled = false;
            }
        }

        // 綁定確認按鈕點擊事件
        confirmBtn.addEventListener('click', uploadImage);
    </script>
</body>
</html>