<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIç™¼æ–‡å°å¹«æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            transition: all 0.3s ease;
        }
        .input-group {
            margin-bottom: 1.5rem;
        }
        .label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #4b5563;
        }
        .input, .select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input:focus, .select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            color: white;
            background-color: #2563eb;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        .btn:hover {
            background-color: #1d4ed8;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #4b5563;
        }
        .tab-button.active {
            background-color: #e0e7ff;
            color: #3730a3;
            border-color: #a5b4fc;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #f0f2f5;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .copy-button:hover {
            background-color: #e5e7eb;
        }
        #error-box {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fca5a5;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            display: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">ğŸš€ AI ç™¼æ–‡å°å¹«æ‰‹</h1>
            <p class="text-gray-600 mt-2">è¼¸å…¥æ‚¨çš„å…§å®¹ï¼Œè®“ AI ç‚ºæ‚¨ç”Ÿæˆç²¾å½©çš„åœ–æ–‡è²¼æ–‡ï¼</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Inputs -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-6">1. è¼¸å…¥è¨­å®š</h2>
                
                <div class="input-group">
                    <label for="apiKey" class="label">Gemini API é‡‘é‘°</label>
                    <input type="password" id="apiKey" class="input" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API é‡‘é‘°">
                </div>

                <!-- Input Source Tabs -->
                <div class="input-group">
                    <label class="label">å…§å®¹ä¾†æº</label>
                    <div id="tabs" class="flex space-x-2 border-b border-gray-200 mb-4">
                        <button class="tab-button active" data-tab="text">ğŸ“ æ–‡å­—</button>
                        <button class="tab-button" data-tab="url">ğŸ”— ç¶²å€</button>
                        <button class="tab-button" data-tab="image">ğŸ–¼ï¸ åœ–ç‰‡</button>
                        <button class="tab-button" data-tab="file">ğŸ“„ æª”æ¡ˆ</button>
                    </div>
                    <div id="tab-content">
                        <!-- Text Input -->
                        <div id="text-tab">
                            <textarea id="text-input" class="input" rows="6" placeholder="è«‹è¼¸å…¥è²¼æ–‡ç›¸é—œçš„æ–‡å­—ã€ä¸»é¡Œæˆ–é—œéµå­—..."></textarea>
                        </div>
                        <!-- URL Input -->
                        <div id="url-tab" class="hidden">
                            <input type="url" id="url-input" class="input" placeholder="https://example.com">
                        </div>
                        <!-- Image Input -->
                        <div id="image-tab" class="hidden">
                            <input type="file" id="image-input" class="input" accept="image/*">
                            <img id="image-preview" class="hidden mt-4 rounded-lg max-w-xs mx-auto" alt="åœ–ç‰‡é è¦½">
                        </div>
                        <!-- File Input -->
                        <div id="file-tab" class="hidden">
                           <input type="file" id="file-input" class="input" accept=".txt,.md,.doc,.docx">
                           <p id="file-name" class="text-sm text-gray-500 mt-2"></p>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label for="post-type" class="label">ç”Ÿæˆå½¢å¼</label>
                    <select id="post-type" class="select">
                        <option value="ä¸€èˆ¬è²¼æ–‡">ä¸€èˆ¬è²¼æ–‡</option>
                        <option value="å»£å‘Šè²¼æ–‡">å»£å‘Šè²¼æ–‡</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="style" class="label">é¢¨æ ¼èªèª¿</label>
                    <select id="style" class="select">
                        <option value="ç„¡">ç„¡ (ç”±AIæ±ºå®š)</option>
                        <option value="å°ˆæ¥­">å°ˆæ¥­</option>
                        <option value="å¹½é»˜">å¹½é»˜</option>
                        <option value="å¼•äººå…¥å‹">å¼•äººå…¥å‹</option>
                        <option value="èˆˆå¥®">èˆˆå¥®</option>
                        <option value="æœ‰å‰µæ„">æœ‰å‰µæ„</option>
                        <option value="é¼“èˆäººå¿ƒ">é¼“èˆäººå¿ƒ</option>
                        <option value="æº«é¦¨">æº«é¦¨</option>
                        <option value="æˆ²åŠ‡æ€§">æˆ²åŠ‡æ€§</option>
                        <option value="è«·åˆº">è«·åˆº</option>
                        <option value="è¦ªåˆ‡">è¦ªåˆ‡</option>
                        <option value="add_new">...æ–°å¢èªèª¿</option>
                    </select>
                </div>

                <div id="custom-style-wrapper" class="input-group hidden">
                    <label for="custom-style-input" class="label">è‡ªè¨‚èªèª¿</label>
                    <input type="text" id="custom-style-input" class="input" placeholder="ä¾‹å¦‚ï¼šåƒæµ·ç›œä¸€æ¨£èªªè©±">
                </div>

                <button id="generate-btn" class="btn">âœ¨ é–‹å§‹ç”Ÿæˆ</button>

                 <div id="error-box">
                    <h3 class="font-bold">ç™¼ç”ŸéŒ¯èª¤</h3>
                    <p id="error-message"></p>
                </div>
            </div>

            <!-- Right Column: Output -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-6">2. ç”Ÿæˆçµæœ</h2>
                <div id="result-container" class="space-y-6">
                    <div id="placeholder" class="text-center text-gray-500 py-20">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <p class="mt-2">ç”Ÿæˆçš„åœ–ç‰‡å’Œæ–‡å­—å°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡</p>
                    </div>
                    <div id="loading-indicator" class="hidden flex flex-col items-center justify-center py-20">
                        <div class="loader"></div>
                        <p class="mt-4 text-gray-600">AI æ­£åœ¨åŠªåŠ›å‰µä½œä¸­ï¼Œè«‹ç¨å€™...</p>
                    </div>
                    <div id="output" class="hidden space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">ç”Ÿæˆåœ–ç‰‡</h3>
                            <div id="image-output" class="flex justify-center items-center bg-gray-100 rounded-lg min-h-[200px]"></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">ç”Ÿæˆæ–‡æ¡ˆ</h3>
                            <div id="text-output" class="relative bg-gray-100 p-4 rounded-lg whitespace-pre-wrap min-h-[150px]">
                                <button id="copy-btn" class="copy-button">è¤‡è£½</button>
                                <p id="text-content"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const apiKeyInput = document.getElementById('apiKey');
        const generateBtn = document.getElementById('generate-btn');
        const tabs = document.querySelectorAll('.tab-button');
        const textInput = document.getElementById('text-input');
        const urlInput = document.getElementById('url-input');
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name');
        const postTypeSelect = document.getElementById('post-type');
        const styleSelect = document.getElementById('style');
        const customStyleWrapper = document.getElementById('custom-style-wrapper');
        const customStyleInput = document.getElementById('custom-style-input');
        
        const placeholder = document.getElementById('placeholder');
        const loadingIndicator = document.getElementById('loading-indicator');
        const outputContainer = document.getElementById('output');
        const imageOutput = document.getElementById('image-output');
        const textContent = document.getElementById('text-content');
        const copyBtn = document.getElementById('copy-btn');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');

        let activeTab = 'text';
        let uploadedImageBase64 = null;
        let uploadedFileContent = null;
        
        // --- Event Listeners ---

        // Tab switching logic
        tabs.forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                activeTab = tabName;
                
                tabs.forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                
                document.querySelectorAll('#tab-content > div').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            });
        });

        // Style dropdown logic
        styleSelect.addEventListener('change', () => {
            if (styleSelect.value === 'add_new') {
                customStyleWrapper.classList.remove('hidden');
            } else {
                customStyleWrapper.classList.add('hidden');
            }
        });

        // Image upload and preview
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedImageBase64 = event.target.result.split(',')[1];
                    imagePreview.src = event.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // File upload logic
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedFileContent = event.target.result;
                    fileNameDisplay.textContent = `å·²é¸æ“‡æª”æ¡ˆ: ${file.name}`;
                };
                reader.readAsText(file);
            }
        });

        // Generate button click
        generateBtn.addEventListener('click', handleGeneration);

        // Copy button
        copyBtn.addEventListener('click', () => {
            const textToCopy = textContent.innerText;
            // Using document.execCommand for broader compatibility in sandboxed environments
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyBtn.textContent = 'å·²è¤‡è£½!';
                setTimeout(() => { copyBtn.textContent = 'è¤‡è£½'; }, 2000);
            } catch (err) {
                console.error('ç„¡æ³•è¤‡è£½æ–‡å­—: ', err);
                copyBtn.textContent = 'è¤‡è£½å¤±æ•—';
            }
            document.body.removeChild(textArea);
        });

        // --- Core Functions ---

        async function handleGeneration() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showError('è«‹è¼¸å…¥æ‚¨çš„ Gemini API é‡‘é‘°ã€‚');
                return;
            }

            // Reset UI
            hideError();
            placeholder.classList.add('hidden');
            outputContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            generateBtn.disabled = true;
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';
            
            try {
                const { prompt, imagePart } = buildPromptAndImage();
                const model = 'gemini-2.5-flash-image-preview'; // Model for text and image generation
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                        ]
                    }],
                    generationConfig: {
                        responseModalities: ['TEXT', 'IMAGE']
                    },
                };
                
                if (imagePart) {
                    payload.contents[0].parts.push(imagePart);
                }

                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                }

                const result = await response.json();
                
                const textPart = result?.candidates?.[0]?.content?.parts?.find(p => p.text)?.text || 'ç„¡æ³•ç”Ÿæˆæ–‡å­—å…§å®¹ã€‚';
                const imageBase64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                displayResults(textPart, imageBase64Data);

            } catch (error) {
                console.error('ç”Ÿæˆéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
                showError(error.message);
                placeholder.classList.remove('hidden'); // Show placeholder on error
            } finally {
                loadingIndicator.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.textContent = 'âœ¨ é–‹å§‹ç”Ÿæˆ';
            }
        }
        
        function buildPromptAndImage() {
            let content = '';
            let imagePart = null;

            switch (activeTab) {
                case 'text':
                    content = `åŸºæ–¼ä»¥ä¸‹æ–‡å­—: "${textInput.value.trim()}"`;
                    break;
                case 'url':
                    content = `åŸºæ–¼é€™å€‹ç¶²å€çš„å…§å®¹ (è«‹è‡ªè¡Œæƒ³åƒå…¶å…§å®¹): ${urlInput.value.trim()}`;
                    break;
                case 'file':
                    content = `åŸºæ–¼ä»¥ä¸‹æ–‡ä»¶å…§å®¹: "${uploadedFileContent}"`;
                    break;
                case 'image':
                    content = 'è«‹æè¿°é€™å¼µåœ–ç‰‡ï¼Œä¸¦ä»¥æ­¤ç‚ºéˆæ„Ÿå‰µä½œã€‚';
                    if (uploadedImageBase64) {
                        imagePart = {
                            inlineData: {
                                mimeType: "image/jpeg", // Assuming jpeg, works for png too
                                data: uploadedImageBase64
                            }
                        };
                    }
                    break;
            }

            const postType = postTypeSelect.value;
            let style = styleSelect.value;
            if (style === 'add_new') {
                style = customStyleInput.value.trim();
            } else if (style === 'ç„¡') {
                style = ''; // Let AI decide
            }
            
            const stylePrompt = style ? `è«‹ä½¿ç”¨ã€Œ${style}ã€çš„é¢¨æ ¼èªèª¿ã€‚` : 'è«‹ä½¿ç”¨æœ€é©åˆçš„é¢¨æ ¼èªèª¿ã€‚';

            const prompt = `
                è«‹æ‰®æ¼”ä¸€ä½ç¤¾ç¾¤åª’é«”è¡ŒéŠ·å°ˆå®¶ã€‚
                ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šæˆ‘æä¾›çš„è³‡æ–™ï¼Œç”Ÿæˆä¸€ä»½åŒ…å«ã€Œåœ–ç‰‡ã€å’Œã€Œæ–‡æ¡ˆã€çš„ç¤¾ç¾¤åª’é«”è²¼æ–‡ã€‚

                ## ä»»å‹™æŒ‡ç¤º:
                1.  **ç”Ÿæˆæ–‡æ¡ˆ**: å‰µä½œä¸€ç¯‡å¼•äººæ³¨ç›®çš„ã€Œ${postType}ã€æ–‡æ¡ˆã€‚${stylePrompt} æ–‡æ¡ˆæ‡‰è©²åŒ…å«ç›¸é—œçš„ hashtagsã€‚
                2.  **ç”Ÿæˆåœ–ç‰‡**: å‰µä½œä¸€å¼µèˆ‡æ–‡æ¡ˆä¸»é¡Œå’Œé¢¨æ ¼ç›¸ç¬¦çš„ç²¾ç¾åœ–ç‰‡ã€‚

                ## è¼¸å…¥è³‡æ–™:
                ${content}

                è«‹ç«‹å³é–‹å§‹å‰µä½œã€‚
            `;
            return { prompt, imagePart };
        }

        function displayResults(text, imageBase64) {
            textContent.innerText = text.trim();
            imageOutput.innerHTML = '';
            
            if (imageBase64) {
                const img = document.createElement('img');
                img.src = `data:image/png;base64,${imageBase64}`;
                img.alt = 'AI ç”Ÿæˆçš„åœ–ç‰‡';
                img.className = 'result-image';
                imageOutput.appendChild(img);
            } else {
                imageOutput.textContent = 'ç„¡æ³•ç”Ÿæˆåœ–ç‰‡ã€‚';
            }
            
            outputContainer.classList.remove('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorBox.style.display = 'block';
        }
        
        function hideError() {
            errorBox.style.display = 'none';
        }
        
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    // 429 is too many requests, a common reason for retry
                    if (response.status === 429 && i < retries - 1) {
                         console.log(`Request throttled. Retrying in ${delay / 1000}s...`);
                         await new Promise(resolve => setTimeout(resolve, delay));
                         delay *= 2; // Exponential backoff
                         continue;
                    }
                    return response;
                } catch (error) {
                    if (i < retries - 1) {
                        console.log(`Request failed. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw error;
                    }
                }
            }
        }

    </script>
</body>
</html>